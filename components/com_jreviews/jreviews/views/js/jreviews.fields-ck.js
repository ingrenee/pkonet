(function(e){function t(t){var n=!1,r,i=this,s=t,o=s.find(':input[class^="jr_"]'),u=s.find('fieldset[id^="group_"]'),a=s.find('li[id^="tab_"]'),f={},l,c=!1;this.getTabs=function(){return a};this.click2add=function(){s.off("click",".jr-click2add-new").on("click",".jr-click2add-new",function(t){t.preventDefault();e(this).closest("div.jrFieldDiv").find("div.jr-click2add-option").toggle()});s.off("click",".jr-click2add-submit").on("click",".jr-click2add-submit",function(t){t.preventDefault();var n=e(this),r=n.parent().siblings("select"),i=n.prev(":input"),s,o,u=i.val(),a="";r.data("controlledBy")&&!(r.data("fieldName")in r.data("controlledBy"))&&e.each(r.data("controlledBy"),function(e,t){s=e;o=t;a="|"+e+"|"+t});var f=encodeURIComponent(u).replace(/'/g,"&#039;")+"|click2add"+a,l=r.children('option[value="'+f+'"]');if(u!==""&&l.length===0){r.append(e("<option></option>").attr({value:f,selected:"selected","data-ordering":99999,"data-controlledBy":s,"data-controlValue":o}).text(u)).data("isActive",!0).trigger("change");i.val("")}else l.length==1&&l.attr("selected","selected");n.siblings(".jr_validation").remove()})};this.loadData=function(t){var n={fieldLocation:"Listing",entry_id:null,value:[],page_setup:0,recallValues:!0,autocomplete:!0,lang:{select_field:jreviews.__t("FIELD_SELECT_FIELD"),no_results:jreviews.__t("FIELD_NO_RESULTS"),instructions:jreviews.__t("FIELD_AUTOCOMPLETE_HELP")}},a={},f=[];t=e.extend(n,t);t.page_setup=t.page_setup?1:0;r=t;r.res=r.res||{};if(jreviews.paid!==undefined&&r.fieldLocation=="Listing")try{if(r.res.planList!==undefined){c=!0;jreviews.paid.plan.planList=r.res.planList;jreviews.paid.plan.plan_selected=jreviews.paid.plan.plan_selected||r.res.plan_selected;jreviews.paid.plan.plan_selected&&s.find('#jr-paid-plan-list :radio[value="'+jreviews.paid.plan.plan_selected+'"]').attr("checked","checked")}else typeof jreviews.paid.plan.planList=="object"&&jreviews.paid.plan.plan_selected!==null&&(c=!0)}catch(h){}l=u.map(function(){return this.id.replace(/group_/g,"")});o.each(function(){if(e(this).attr("type")!="button"){var t=e(this).data("selected"),n=e(this).attr("class").split(" ")[0].replace(/[^a-zA-Z0-9_\s]+/g,"").match(/^jr_[a-z0-9]+/).toString();if(t){a[n]=String(t).search("_")>-1?t.split("_"):[t];e(this).removeAttr("data-selected");e(this).removeData("selected")}e.inArray(n,f)==-1&&f.push(n)}});f=e.unique(f);if(f.length){e.isEmptyObject(f)||(t.value=a);var p=jreviews.dispatch({method:"POST",type:"json",controller:"fields",action:"_loadFieldData",data:{"data[entry_id]":t.entry_id,"data[fields]":f,"data[value]":a,"data[page_setup]":t.page_setup,"data[fieldLocation]":t.fieldLocation,"data[referrer]":t.referrer,"data[autocomplete]":t.autocomplete}});p.done(function(e){i.processResponse(t.value,t.page_setup,e);if(c){jreviews.paid.plan.controlFieldClass=i;jreviews.paid.plan.formFilter(s)}i.click2add();r.fieldLocation=="Listing"&&s.trigger("jrListingFieldsLoaded")});return p}return!1};this.getPaidFields=function(){var e=jreviews.paid.plan.planList,t=s.find("#jr-paid-plan-list"),n=jreviews.paid.plan.plan_selected;if(typeof e=="object"&&n!==null)return e["plan"+n]!==undefined?e["plan"+n].fields:[]};this.getFieldOptions=function(e,t){var n;switch(t){case"select":case"selectmultiple":n=e.children("option");break;default:n=e}return n};this.getFieldObj=function(e){return e in f?f[e]:!1};this.setValidFields=function(t){var n=[];t=t||s;s.find(":input").filter(function(){e(this).closest("fieldset").data("isActive")!==!1&&e(this).data("isActive")===!0&&n.push(e(this).data("fieldName"))});var r=t.find('[name="data[valid_fields]"]');r.length?r.val(n.join(",")):t.append(e('<input type="hidden" name="data[valid_fields]" />').val(n.join(",")));return e.unique(n)};this.getjQueryObj=function(t,n){if(undefined!==t.fields&&n in t.fields){var i=!1;if(n in f)return f[n];var o=["selectmultiple","checkboxes"];if(e.inArray(r.referrer,["adv_search_module"])>-1){var u=s.find("."+n),a;a=u.prop("type");switch(a){case"select-one":t.fields[n].type="select";break;case"select-multiple":t.fields[n].type="selectmultiple"}}e.inArray(r.referrer,["adv_search_module","adv_search"])>-1&&e.inArray(t.fields[n].type,["integer","decimal","date"])>-1&&(i=!0);var l=e.inArray(t.fields[n].type,o)>-1||i,c=':input[name="data[Field]['+t.location+"]["+n+"]"+(l?'[]"]':'"]');f[n]=s.find(c);return f[n]}return!1};this.storeValues=function(t,n){var r=t.data("fieldOptions")||{},s=t.data("fieldType"),o=i.getFieldOptions(t,s);n=e.isArray(n)?n:[n];e(n).each(function(n,s){if(s in r){e(r[s].dependent_groups).each(function(n,r){u.filter("fieldset#group_"+r).find(":input").each(function(){$dep_field=e(this);if($dep_field.data("isControlled")===!1||$dep_field.data("isControlled")===!0&&$dep_field.data("hasControl")===!0){i.debug("6.1 >--- Store current val of "+$dep_field.data("fieldName")+"["+$dep_field.val()+"] for "+t.data("fieldName")+"["+s+"]");var n=$dep_field.data("parentMemory")||[],r=t.data("fieldName")+"."+s;n[r]=$dep_field.val();$dep_field.data("parentMemory",n)}if($dep_field.data("hasControl")===!0){var o=$dep_field.val();i.debug("6.1 >--- Run recursively for ["+$dep_field.attr("class").split(" ")[0]+"["+o+"]");o!==null&&i.storeValues($dep_field,o)}})});e(r[s].dependent_fields).each(function(e,n){var o=i.getjQueryObj(r[s],n);if(o.length===0)return!0;var u=r[s].fields[n].type,a;i.debug("6.2 >--- Store current val of "+u+" "+o.data("fieldName")+"["+o.val()+"] for "+t.data("fieldName")+"["+s+"]");var f=o.data("parentMemory")||[],l=t.data("fieldName")+"."+s;switch(u){case"checkboxes":case"radio":a=o.filter(":checked").map(function(){return this.value}).get();break;default:a=o.val()}f[l]=a;o.data("parentMemory",f);if(o.val()!==null){i.debug("6.2 >--- Run recursively");i.storeValues(o,o.val())}})}})};this.recallValue=function(t,n,r){var s=t.data("parentMemory")||[],o=n+"."+r;if(s[o]!==undefined){i.debug("** Recall ParentMemory:"+t.data("fieldName")+" = ["+n+":"+r+"] => "+s[o]);var u=t.data("fieldType");e.inArray(u,["checkboxes","radiobuttons"])>-1?t.each(function(){var t=e(this).val();e(this).attr("checked",e.inArray(t,s[o])>-1)}):t.val(s[o]);t.trigger("change")}};this.clearDependents=function(t,n,r){var s=t.data("fieldOptions")||{},o=[],f=n,l=t.data("fieldType"),c=i.getFieldOptions(t,l);i.debug("5 >--- Clear dependents of "+t.attr("class").split(" ")[0]+"["+n+"]. Event type is "+t.data("eventType"));o=e.isArray(n)?n:[n];e(o).each(function(t,n){if(n in s){e(s[n].dependent_groups).each(function(t,n){i.debug("Hide dependent group: "+n);var r=!0;c.each(function(){var t=e(this);s[t.val()]&&(t.is(":checked")||t.is(":selected"))&&e.inArray(n,s[t.val()].dependent_groups)>-1&&(r=!1)});if(r){var o=u.filter("fieldset#group_"+n);o.data("isActive",!1).css("display","none").find(":input").val("").data("doNotStore",!0).trigger("change");a.length&&a.filter("li#tab_"+n).hide()}});e(s[n].dependent_fields).each(function(t,o){var u=i.getjQueryObj(s[n],o);if(u.length===0)return!0;var a=s[n].fields[o].type;i.debug("5.0 >--- Clear dependent ["+o+"]["+n+"]["+a+"]");var f=u.val();if(e.inArray(a,["select","selectmultiple"])>-1){i.debug("5.1 >---",a);e(s[n].fields[o].options).each(function(){var t=this.value;i.debug(o+"["+a+"]"+"["+t+"]");if(e.inArray(l,["checkboxes","selectmultiple"]>-1)){var n=!0;c.each(function(){var r=e(this);s[r.val()]&&(r.is(":checked")||r.is(":selected"))&&e(s[r.val()].fields[o]).each(function(){e(this.options).each(function(){this.value==t&&(n=!1)})})});if(n){i.debug("5.1.1 >----- Removing field option ["+t+"]");u.children('option[value="'+t+'"]').remove()}}else{i.debug("5.1.2 >-----");u.children('option[value="'+t+'"]').remove()}t!==null&&i.clearDependents(u,t)});u.data("old_val","");var h=u.children("option").length;if(a=="select"&&h==1||a=="selectmultiple"&&h===0){var p=u.data("click2add")||0;(p===0||p==1&&u.data("isControlled"))&&u.data("isActive",!1).val("").closest("div.jrFieldDiv").css("display","none")}}else{i.debug("5.2 >--- "+a);u.data("old_val","");var d=!0;if(e.inArray(l,["checkboxes","selectmultiple"]>-1)){c.each(function(){var t=e(this);s[t.val()]&&(t.is(":checked")||t.is(":selected"))&&e.inArray(o,s[t.val()].dependent_fields)>-1&&(d=!1)});d&&(e.inArray(a,["checkboxes","radiobuttons"]>-1)?u.removeAttr("checked"):u.val(""))}else e.inArray(a,["checkboxes","radiobuttons"]>-1)?u.removeAttr("checked"):u.val("");if(!(!d||r!==undefined&&s[r]!==undefined&&s[r].dependent_fields.length>0&&e.inArray(o,s[r].dependent_fields)>-1)){i.debug("   ----- Hiding dependent field "+o);u.data("isActive",!1).closest("div.jrFieldDiv").css("display","none")}}u.trigger("change")})}})};this.processResponse=function(t,n,o){if(o.length===0)return;if(o.responses!==undefined){e.each(o.responses,function(t,n){var r=i.getjQueryObj(o,t);if(!r)return!0;e.each(n,function(e,n){i.debug("1 >-- Caching response data for "+t+"["+n.control_value+"]");var s=r.data("fieldOptions")||{};s[n.control_value]=n;r.data("fieldOptions",s)})});if(n){i.populateOptions(o);try{s.find(".jrRelatedListing").relatedlisting()}catch(u){}}}e.each(o.control_field,function(t,n){var u=i.getjQueryObj(o,n);if(undefined===o.fields||o.fields[n].type=="text")return!0;u.on("change",function(){i.debug("2 >--- Change event triggered for "+n+", id = "+u.attr("class").split(" ")[0]+", "+o.fields[n].type);var t="",a=[],f=[],l=u.data("old_val")||(e.inArray(o.fields[n].type,["selectmultiple"])?[]:null),c,h,p;i.debug("   Old val: "+l);switch(o.fields[n].type){case"radiobuttons":t=e(this).val();break;case"selectmultiple":u.children("option").not(":selected").each(function(){f.push(e(this).val())});a=u.val();a===null&&(a=[]);if(a.length==1)t=a[0];else if(l!==null)for(var d=0;d<a.length;d++)if(e.inArray(a[d],l)==-1){t=u.children('option[value="'+a[d]+'"]').val();break}break;case"checkboxes":u.each(function(){e(this).is(":checked")&&a.push(e(this).val())});e(this).is(":checked")&&(t=e(this).val());p=e(this).val();break;default:t=u.val()}i.debug("   Sel val: "+t);var v;switch(o.fields[n].type){case"checkboxes":t===""&&(v=p);break;case"selectmultiple":f.length>0&&(v=f);break;default:v=l}var m=u.data("doNotStore")||!1;r.recallValues&&l!==null&&l.length>0&&m===!1&&i.storeValues(u,l);u.data("old_val",a.length?a:t);var g=u.data("fieldOptions")||{};cachedResp=t===null||g=={}?null:g[t];i.debug("   Cached response");i.debug(undefined===cachedResp?"       Not cached":cachedResp);if(cachedResp===undefined&&t!==""&&t!==null){i.debug(" -> Change Event AJAX");u.attr("disabled","disabled");var y={"data[fields]":n,"data[value]":t,"data[page_setup]":!1,"data[fieldLocation]":r.fieldLocation,"data[referrer]":r.referrer,"data[autocomplete]":r.autocomplete},b=jreviews.dispatch({method:"post",type:"json",controller:"fields",action:"_loadFieldData",data:y});b.done(function(e){i.debug("1 >-- Caching data for "+n+"["+t+"]");var r=u.data("fieldOptions")||{};r[t]=e;u.data("fieldOptions",r);u.data("eventType","ajax");undefined===e.fields&&(e.fields=[]);i.populateOptions(e,o.fields[n],u,v,t);s.trigger("jrAfterFieldChange")})}else if(!e.isEmptyObject(cachedResp)&&t!==""){i.debug(" -> Change Event CACHED");u.data("eventType","cached");i.populateOptions(cachedResp,o.fields[n],u,v,t);s.trigger("jrAfterFieldChange")}else{i.debug(" -> Change Event CLEAR");u.data("eventType","clear");i.clearDependents(u,v,t);s.trigger("jrAfterFieldChange")}u.removeAttr("disabled");u.data("doNotStore",!1)});if(u.hasClass("jrAutoComplete")&&e.inArray(u.data("fieldType"),["select","selectmultiple"])>-1){i.debug(" -> Activate AutoComplete UI for "+n);u.autocompletefield({optionType:u.data("autocompleteType"),optionDivPosition:u.data("autocompletePos")})}})};this.populateOptions=function(t,n,s,o,f){if(t.length===0)return;n=n!==undefined?n:{type:"",name:""};i.debug("4 >--- Populate options for "+n.name+"["+f+"] and we clear it for ["+o+"]");t.page_setup&&e.each(l,function(n,r){if(e.inArray(r,t.dependent_groups)==-1){var i=u.filter("fieldset#group_"+r),s=0;i.find(":input").each(function(){e(this).attr("type")!="hidden"&&s++});if(s>0){i.show();a.length&&a.filter("li#tab_"+r).show(10)}}});e.each(t.dependent_groups,function(e,n){var r=u.filter("fieldset#group_"+n);r.data("isControlled",!0);if(t.page_setup){r.css("display","none").data("isActive",!1);a.length&&a.filter("li#tab_"+n).hide()}else{r.show().data("isActive",!0);a.length&&a.filter("li#tab_"+n).show(10)}});var h=[];if(c){h=i.getPaidFields();i.debug("   --- It is a paid listing!");i.debug(h)}e.each(t.fields,function(n,s){i.debug("   --- Populating field "+s.name+"["+s.title+"]["+f+"]");if(e.isArray(s.name))return!0;var o=i.getjQueryObj(t,s.name),a;try{a=o.prop("type")}catch(l){a=o.attr("type")}switch(a){case"select-one":s.type="select";break;case"select-multiple":s.type="selectmultiple"}o.data("fieldTitle",s.title);t.page_setup===0&&e.inArray(s.type,["select","selectmultiple"])>-1&&o.val("");if(t.page_setup){o.data("fieldName",s.name);o.data("fieldType",s.type);o.data("orderBy",s.order_by);o.data("hasControl",s.control);o.data("isControlled",s.controlled);o.data("autocompleteType",s.autocompletetype);o.data("autocompletePos",s.autocompletepos)}var p=e.inArray(s.group,t.dependent_groups)>-1,d=u.filter("fieldset#group_"+s.group).data("isActive");if(t.control_field.length==1){var v=o.data("controlledBy")||{};v[t.control_field[0]]=t.control_value;p||o.data("controlledBy",v);if((t.page_setup===0||t.page_setup===undefined)&&s.type=="text"&&s.controlled===!0&&s.controlgroup===!0)return!0}if(o.data("isActive")===undefined&&t.page_setup&&(e.inArray(s.type,["select","selectmultiple"])>-1&&(s.control===!0&&s.controlled===!0||s.control===!1&&s.controlled===!0||s.autocomplete=="0"&&s.options===undefined)||e.inArray(s.type,["checkboxes","radiobuttons"])>-1&&(s.control===!0&&s.controlled===!0||s.control===!1&&s.controlled===!0)||!s.control&&s.controlled&&(s.selected===undefined||s.selected.length===0))){s.type=="select"&&o.html(e("<option></option>").attr("value","").text(r.lang.select_field.replace("%s",o.data("fieldTitle"))).data("ordering",0)).children("option:eq(0)").attr("selected","selected");i.debug("   ----- Hiding field "+s.name+" on startup");var m=o.data("click2add")||0;(m===0||m==1&&o.data("isControlled"))&&o.data("isActive",!1).closest("div.jrFieldDiv").css("display","none");return!0}s.type=="select"&&o.children("option").length===0&&o.html(e("<option></option>").attr("value","").text(r.lang.select_field.replace("%s",o.data("fieldTitle"))).data("ordering",0));if(e.inArray(s.type,["select","selectmultiple"])>-1){o.children('option[data-controlledBy="'+t.control_field[0]+'"]').each(function(){var n=e(this);n.data("controlValue")!=t.control_value&&n.remove()});e(s.options).each(function(){o.children('option[value="'+this.value+'"]').length===0&&o.append(e("<option></option>").attr("value",this.value).text(this.text).attr("data-ordering",this.ordering))})}if(t.edit&&s.selected!==undefined&&s.selected.length>0){e.inArray(s.type,["checkboxes","radiobuttons"])==-1&&o.val(s.selected);o.data("old_val",s.selected);e(s.selected).each(function(e,n){if(s.name in t.responses&&n in t.responses[s.name]){i.debug("  +++++++ Start populateOptions recursion for "+s.name);o.data("eventType","cached");i.populateOptions(t.responses[s.name][n],s,o,undefined,n)}})}s.type=="select"&&o.find(":selected").length===0&&o.children("option:eq(0)").attr("selected","selected");if(!t.page_setup&&c&&e.inArray(s.name,h)==-1){o.data("isActive",!0);return!0}i.debug("   ***** Start checks for displaying fields for ["+s.title+"]["+s.type+"]");if(p&&d!==!0)o.data("isActive",!1).closest("div.jrFieldDiv").hide();else switch(s.type){case"select":o.children("option").length>1||o.data("click2add")==1&&!p||o.data("hasControl")===!0&&o.data("isControlled")===!1||o.data("hasControl")===!1&&o.data("isControlled")===!1?o.data("isActive",!0).closest("div.jrFieldDiv").show():o.data("isActive",!1).closest("div.jrFieldDiv").hide();break;case"selectmultiple":(o.children("option").length>0||o.data("click2add")==1&&!p||o.data("hasControl")===!0&&o.data("isControlled")===!1||o.data("hasControl")===!1&&o.data("isControlled")===!1)&&o.data("isActive",!0).closest("div.jrFieldDiv").show();break;case"checkboxes":case"radiobuttons":(!p||p&&d&&o.data("hasControl")===!0&&o.data("isControlled")===!1||o.data("hasControl")===!1&&o.data("isControlled")===!1)&&o.data("isActive",!0).closest("div.jrFieldDiv").show();break;default:o.data("isActive",!0).closest("div.jrFieldDiv").show()}o.children("option").length>0&&o.data("orderBy")=="ordering"&&i.sort_by_field(o)});undefined!==s&&undefined!==o&&i.clearDependents(s,o,f);if(!t.page_setup&&r.recallValues){e(t.dependent_fields).each(function(t,r){i.recallValue(e("."+r),n.name,f)});e.each(t.dependent_groups,function(t,r){u.filter("fieldset#group_"+r).find(":input").each(function(){var t=e(this).data("hasControl"),r=e(this).data("isControlled");(t||t===!1&&r===!1)&&i.recallValue(e(this),n.name,f)})})}};this.sort_by_field=function(t){var n=t.val(),r=t.data("orderBy"),i,s,o=r=="ordering"?function(e){return parseInt(e,10)}:function(e){return e.toUpperCase()};try{i=t.prop("type")}catch(u){i=t.attr("type")}i=="select-one"&&(s=t.children('option[value=""]').detach());var a=t.children("option").sort(function(t,n){t=r=="ordering"?e(t).data("ordering"):t.text;n=r=="ordering"?e(n).data("ordering"):n.text;if(typeof o!="undefined"){t=o(t);n=o(n)}return t<n?-1:t>n?1:0});s!==undefined?t.html(a).prepend(s).val(n):t.html(a).val(n)};this.debug=function(e){n&&console.log(e)}}e.fn.jreviewsFields=function(e){var n=new t(this);return n.loadData(e)};e.fn.jrSetValidFields=function(){var e=new t(this);return e.setValidFields(this)}})(jQuery);(function(e){e.widget("jreviews.relatedlisting",{options:{minLength:1,classes:"jrAutoSuggest",instructionsClass:"acInstructions",lang:{help:jreviews.__t("FIELD_AUTOCOMPLETE_HELP"),no_results:jreviews.__t("FIELD_NO_RESULTS")},listingTitleClass:"jrRelatedListingTitle"},_create:function(){var t=this.element.hide(),n=this.options,r=(this.searchInput=e('<input type="text" />')).val(n.lang.help).addClass(n.instructionsClass).addClass(n.classes).insertAfter(t),i=(this.labelCheckbox=e('<input class="jrLeft" type="checkbox" />')).attr("checked","checked").hide(),s=(this.noResults=e("<span></span>")).html(n.lang.no_results).css("margin-left","5px").addClass("jrValidation");searchLabel=(this.searchLabel=e("<span />")).addClass(n.listingTitleClass);t.data("validation",!1);e('<div class="jrRelatedListingSelected">').append(i,searchLabel).insertAfter(r);this._bindEvents()},_init:function(){var e=this,t=this.element,n=this.options,r=t.val(),i=this.searchLabel;r>0&&e._getListingData("",function(e){i.html(e[0].label).trigger("selected")},r)},_getListingData:function(e,t,n){var r=this.element;n=n||"";var i={limit:12,id:n,fname:r.attr("class").split(" ")[0],listingtype:r.data("listingtype")||"",value:e},s=jreviews.dispatch({method:"get",type:"json",controller:"fields",action:"relatedListings",data:i});s.done(function(e){t(e)})},_bindEvents:function(){var t=this,n=this.options,r=this.element,i=this.searchInput,s=this.searchLabel,o=this.labelCheckbox;i.on("click focusin",function(){i.val("").removeClass(n.instructionsClass)}).on("blur",function(){i.val(n.lang.help).addClass(n.instructionsClass)}).autocomplete({minLength:n.minLength,source:function(n,r){var i=this.element,s=n.term.toLowerCase(),o=i.data("autocompleteCache")||{},u=!1,a=[],f=[];e.each(o,function(e,t){if(s==e&&t.length>0){r(t);u=!0;return}});if(u)return;t._getListingData(s,function(n){o[s]=n;i.data("autocompleteCache",o);e(n).each(function(t,n){n!==undefined&&e.inArray(n.value,f)==-1&&a.push(n)});r(a);t._noMatch(a)})},search:function(e,t){},focus:function(e,t){s.html(t.item.label);return!1},select:function(e,t){r.val(t.item.value);i.val("");s.trigger("selected");return!1}});s.on("selected",function(){o.attr("checked","checked").show(5)});o.on("click",function(){if(o.is(":checked")===!1){o.hide();s.html("");r.val("")}})},_noMatch:function(t){var n=this.element,r=this.noResults;if(t.length===0&&n.data("validation")===!1){n.prevAll("label:eq(0)").append(r).data("validation",!0);r.fadeIn(100).delay(3e3).fadeOut(500,function(){e(this).detach();n.data("validation",!1)})}},destroy:function(){}})})(jQuery);(function(e){e.widget("jreviews.autocompletefield",{options:{optionType:"link",optionDivPosition:"after",minSearchLength:1,lang:{help:jreviews.__t("FIELD_AUTOCOMPLETE_HELP"),no_results:jreviews.__t("FIELD_NO_RESULTS")},helpClass:"acInstructions",inputClass:"jrAutoSuggest",disabledLinkClass:"ui-disabled",checkboxClass:"ui-option",optionsDivClass:"ui-optionsDiv"},_create:function(){var t=this.element.hide(),n=this.options,r=this.fname=t.data("field").name,i=this.fid=t.data("field").id,s=this.widgetid="text-"+r;t.data("validation",!1);var o=(this.searchInput=e('<input type="text" />')).attr({id:s,name:s}).val(n.lang.help).addClass(n.helpClass+" "+n.inputClass).insertAfter(t),u=(this.optionsDiv=e("<div></div")).attr("data-fname",r).addClass(n.optionsDivClass+" jrClearfix"),a=(this.noResults=e("<span></span>")).html(n.lang.no_results).css("margin-left","5px").addClass("jrValidation");switch(n.optionDivPosition){case"before":u.insertBefore(o);break;case"after":u.insertAfter(o)}this._bindEvents()},_init:function(){var t=this,n=this.element,r=this.options,i=this.optionsDiv,s=n.children("option:selected");s.length&&e.each(s,function(){var n=e(this);if(n.val()==="")return!0;switch(r.optionType){case"link":var s=t._createLink({value:n.val(),text:n.text(),checked:!0});break;case"checkbox":s=t._createCheckbox({value:n.val(),text:n.text(),checked:!0})}i.append(s)});switch(r.optionType){case"link":i.find("a").length===0?i.hide():i.show(5);break;case"checkbox":i.find("input").length===0?i.hide():i.show(5)}},_bindEvents:function(){var t=this,n=this.element,r=this.options,i=this.searchInput,s=this.optionsDiv;i.on("click focusin",function(){this.value==r.lang.help&&e(this).val("").removeClass(r.helpClass)}).on("blur focusout",function(){this.value===""&&e(this).val(r.lang.help).addClass(r.helpClass)});this._bindAutoComplete();s.delegate(":input:checkbox","change",function(){var t=e(this),r=t.val(),i=t.next("span").html(),s=n.children('option[value="'+r+'"]');t.is(":checked")?s.length>0?s.attr("selected","selected"):s.append(e("<option></option>").attr("value",r).text(i)):s.length>0&&s.removeAttr("selected");n.trigger("change");return!1}).delegate("a","click",function(){var t=e(this),i=t.data("value"),s=t.html(),u=n.children('option[value="'+i+'"]');if(t.data("active")===!1){t.data("active",!0).removeClass(r.disabledLinkClass);u.length>0?u.attr("selected","selected"):u.append(e("<option></option>").attr("value",i).text(s))}else if(u.length>0){t.data("active",!1).addClass(r.disabledLinkClass);u.removeAttr("selected")}n.trigger("change");return!1});switch(r.optionType){case"link":this._bindForLinks();break;case"checkbox":this._bindForCheckboxes()}this._bindClick2Add()},_bindForCheckboxes:function(){var t=this,n=this.element,r=this.options,i=this.optionsDiv;n.on("change",function(){var r=i.find(":input"),s=n.children("option"),o=s.map(function(){return this.value});s.each(function(){var n=e(this),r=n.val();if(r!==""){var s=i.find(':input[value="'+r+'"]');n.is(":selected")===!1?s.length&&s.removeAttr("checked"):s.length?s.attr("checked","checked"):i.show(5).append(t._createCheckbox({value:r,text:n.text(),checked:!0}))}});r.each(function(){var t=e(this);e.inArray(t.val(),o)==-1&&t.closest("label").remove()});i.find(":input").length===0&&i.hide()})},_bindForLinks:function(){var t=this,n=this.element,r=this.options,i=this.optionsDiv;n.on("change",function(){var s=i.find("a"),u=n.children("option"),a=u.map(function(){return this.value});u.each(function(){var n=e(this),s=n.val();if(s!==""){var u=i.find('a[data-value="'+s+'"]');n.is(":selected")===!1?u.length&&u.data("active",!1).addClass(r.disabledLinkClass):u.length?u.data("active",!0).removeClass(r.disabledLinkClass):i.show(5).append(t._createLink({value:s,text:n.text(),checked:!0}))}});s.each(function(){var t=e(this);e.inArray(String(t.data("value")),a)==-1&&t.remove()});i.find("a").length===0&&i.hide()})},_bindAutoComplete:function(){var t=this,n=this.element,r=this.options,i=this.searchInput,s=this.optionsDiv,o=this.fid,u=this.fname;if(jreviews.isRTL)var a="right top",f="right bottom";else var a="left top",f="left bottom";i.autocomplete({position:{my:a,at:f},source:function(u,a){var f=u.term.toLowerCase(),l=i.data("cache")||[],c=[],h;switch(r.optionType){case"link":h=s.find("a").map(function(){return e(this).data("value")});break;case"checkbox":h=s.find(":input").map(function(){return this.value})}if(n.data("isControlled")){var p=new RegExp(e.ui.autocomplete.escapeRegex(u.term),"i");c=n.children("option").map(function(){var t=e(this).text();if(this.value!==""&&(!u.term||p.test(t))&&e.inArray(this.value,h)==-1)return{label:t,value:this.value}});a(c);t._noMatch(c)}else if(l[f]){e(l[f]).each(function(t,n){n!==undefined&&e.inArray(n.value,h)==-1&&c.push(n)});a(c);t._noMatch(c)}else{var d={limit:12,field_id:o,value:f},v=jreviews.dispatch({method:"get",type:"json",controller:"fields",action:"_loadValues",data:d});v.done(function(n){l[f]=n;i.data("cache",l);e(n).each(function(t,n){n!==undefined&&e.inArray(n.value,h)==-1&&c.push(n)});a(c);t._noMatch(c)})}},search:function(e,t){if(o==="")return!1},minLength:r.minSearchLength,focus:function(e,t){i.val(t.item.label);return!1},select:function(t,r){if(r.item.value!==""){i.val("").focus();var s=n.val()||[],o=n.children('option[value="'+r.item.value+'"]'),u;n.val("").trigger("change");o.length===0&&n.append(e("<option></option>").attr({value:r.item.value}).text(r.item.label));try{u=n.prop("type")}catch(a){u=n.attr("type")}if(u=="select-multiple"){s.push(r.item.value);n.val(s)}else n.val(r.item.value);n.trigger("change")}i.val("");return!1}});e(".ui-autocomplete").css("text-align","left")},_bindClick2Add:function(){var t=this.element,n=this.options,r=this.searchInput;t.data("click2add")==1&&e('<button class="jrButton" />').html('<span class="jrIconNew"></span>'+jreviews.__t("FIELD_ADD_OPTION")).on("click",function(i){i.preventDefault();var s=r.val(),u="",a,f;t.data("controlledBy")&&!(t.data("fieldName")in t.data("controlledBy"))&&e.each(t.data("controlledBy"),function(e,t){a=e;f=t;u="|"+e+"|"+t});var l=encodeURIComponent(s).replace(/'/g,"&#039;")+"|click2add"+u,c=t.children('option[value="'+l+'"]');if(s!==""&&s!=n.lang.help&&c.length===0){t.append(e("<option></option>").attr({value:l,selected:"selected","data-ordering":99999,"data-controlledBy":a,"data-controlValue":f}).text(s)).trigger("change");r.val("")}else if(c.length==1){c.attr("selected","selected");t.trigger("change")}r.focus()}).insertAfter(r)},_createCheckbox:function(t){var n=this.fname,r=this.options,i="cb-"+n+"_"+t.value.replace(/ /g,"_"),s=e('<input type="checkbox" />').attr({id:i,name:i}).addClass(r.checkboxClass).val(t.value).attr("checked",t.checked),o=e('<label for="'+i+'" />').css("text-align","left").append(s).append("<span>"+t.text+"</span>");return o},_createLink:function(t){var n=this.options;return e('<a href="javascript:void(0)"></a>').addClass(n.checkboxClass).html(t.text).attr("data-value",t.value).data("active",t.checked?!0:!1)},_noMatch:function(t){var n=this.element,r=this.noResults;if(t.length===0&&n.data("validation")===!1){n.prevAll("label:eq(0)").append(r).data("validation",!0);r.fadeIn(100).delay(3e3).fadeOut(500,function(){e(this).detach();n.data("validation",!1)})}},_destroy:function(){}})})(jQuery);
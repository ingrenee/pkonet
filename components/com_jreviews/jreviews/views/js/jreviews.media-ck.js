var jreviewsMedia=jreviewsMedia||{};jreviewsMedia._options={galleryId:"mediaGallery",uploader:{},mediaDiv:{},polling_period:2e4};(function(e){e.fn.serializeObject=function(){var t={},n=this.serializeArray();e.each(n,function(){if(t[this.name]!==undefined){t[this.name].push||(t[this.name]=[t[this.name]]);t[this.name].push(this.value||"")}else t[this.name]=this.value||""});return t};jreviewsMedia.upload_valid=!0;jreviewsMedia.addElement=function(e,t){this._el=this._el||[];this._el[e]=t};jreviewsMedia.getElement=function(e){return this._el[e]};jreviewsMedia.initUploader=function(t,n){e("#jr-terms-checkbox-upload, #jr-terms-checkbox-link").removeAttr("checked");var r=e("#jr-embed-submit");r.on("click",function(t){r.trigger("beginUpload");t.stopImmediatePropagation();if(jreviewsMedia.upload_valid===!0){var n=e(this),i=e("input#jr-embed-url"),s=e('<span class="jrLoadingSmall"></span>');if(i.val()!==""){n.attr("disabled","disabled").after(s);var o=jreviewsMedia.embed();o.done(function(){s.remove();n.removeAttr("disabled")})}}});var i=e("#jr-upload-url-submit");i.on("click",function(t){i.trigger("beginUpload");t.stopImmediatePropagation();if(jreviewsMedia.upload_valid===!0){var n=e(this),r=e("input#jr-upload-url"),s=e('<span class="jrLoadingSmall"></span>');if(r.val()!==""){n.attr("disabled","disabled").after(s);var o=jreviewsMedia.uploadFromUrl();o.done(function(){s.remove();n.removeAttr("disabled")})}}});e("div.jr-tabs").find("div[id$='-tab']").on("delete",function(){var t=e(".media-file-list"),n=e(".media-file-list-url"),r=e(".media-linked-videos");if(t.children("div").length===0){t.closest("fieldset").hide();e(".jr-upload-complete-actions").slideUp()}if(n.children("div").length===0){n.closest("fieldset").hide();e(".jr-upload-url-complete-actions").slideUp()}if(r.children("div").length===0){r.hide();e(".jr-embed-complete-actions").slideUp()}});var s=this;this._options.uploader={element:document.getElementById(uploader_id=t||"jr-media-uploader"),action:s2AjaxUri,params:e("#jr-uploaded-media").serializeObject(),template:e.trim(e("#jr-uploader-template").html()),fileTemplate:e.trim(e("#jr-progress-template").html()),disableCancelForFormUploads:!0,classes:{button:"jr-upload-button",drop:"jr-upload-drop-area",dropActive:"jr-upload-drop-area-active",list:"jr-file-list",file:"jr-upload-file",spinner:"jr-upload-spinner",size:"jr-upload-size",cancel:"jr-upload-cancel",progress:"jr-upload-progress",success:"jr-upload-success",fail:"jr-upload-fail"},messages:{typeError:jreviews.__t("MEDIA_UPLOAD_TYPE_ERROR"),sizeError:jreviews.__t("MEDIA_UPLOAD_SIZE_ERROR"),emptyError:jreviews.__t("MEDIA_UPLOAD_EMPTY_ERROR"),noFilesError:jreviews.__t("MEDIA_UPLOAD_NOFILE_ERROR"),onLeave:jreviews.__t("MEDIA_UPLOAD_ONLEAVE")},showMessage:function(t){e(".jr-media-message").show().prepend("<li>"+t+"</li>")},onSubmit:function(t,n){jreviewsMedia.upload_valid=!0;e(".jr-upload-button input").trigger("beginUpload");if(!jreviewsMedia.upload_valid)return!1;this.params=e("#jr-form-media-upload").serializeObject();var r=e("#jr-user-info");if(r.length>0){var i=r.serializeObject();e.extend(this.params,i)}var s=e(".jr-file-list").detach();e(".media-file-list").show().append(s);e(".jr-upload-complete-actions").slideUp()},onComplete:function(t,n,r){r.id=t;if(!r.success&&r.str!==undefined){e(".jr-media-message").append(jreviews.__t(r.str,{add_ul:!1})).show();return!1}r.success===!0&&s.addMediaDiv(r,n);r.state=="finished"&&r.thumb_url!==""&&s.updateThumb(r);r.success&&r.encoding_job!==undefined&&s.checkEncodingJobStatus(r);s.jrUploader._filesInProgress===0&&e(".jr-upload-complete-actions").slideDown()}};qq.extend(qq.FileUploader.prototype,{_addToList:function(e,t){var n=qq.toElement(this._options.fileTemplate);n.qqFileId=e;var r=this._find(n,"file");qq.setText(r,this._formatFileName(t));this._find(n,"size").style.display="none";this._listElement.appendChild(n);this._listElement.insertBefore(n,this._listElement.childNodes[0])},_bindCancelEvent:function(){var t=this,n=this._listElement;qq.attach(n,"click",function(n){n=n||window.event;var r=n.target||n.srcElement;if(qq.hasClass(r,t._classes.cancel)){qq.preventDefault(n);var i=r.parentNode.parentNode;t._handler.cancel(i.qqFileId);qq.remove(i);e("div.jr-tabs").find("div[id$='-tab']").trigger("delete")}})},_onProgress:function(t,n,r,i){qq.FileUploaderBasic.prototype._onProgress.apply(this,arguments);var s=this._getItemByFileId(t),o=this._find(s,"size");o.style.display="inline";var u=this._find(s,"progress"),a;if(r!=i){var f=Math.round(r/i*100);e(u).progressbar({value:f});a=f+"% of "+this._formatSize(i)}else{e(u).progressbar({value:100});a=this._formatSize(i)}qq.setText(o,a)},_uploadFileList:function(e){var t=this,n=[];for(var r=0;r<e.length;r++)this._validateFile(e[r])&&n.push(e[r]);for(var i=0;i<n.length;i++)this._uploadFile(n[i])},_validateFile:function(t){var n,r;if(t.value)n=t.value.replace(/.*(\/|\\)/,"");else{n=t.fileName!==undefined?t.fileName:t.name;r=t.fileSize!==undefined?t.fileSize:t.size}this._options.allowedExtensions=[];if(this._options.fileValidation===undefined)return!0;var i=-1!==n.indexOf(".")?n.replace(/.*[.]/,"").toLowerCase():"";for(var s=0;s<this._options.fileValidation.length;s++){e.merge(this._options.allowedExtensions,this._options.fileValidation[s].allowedExtensions);e.inArray(i,this._options.fileValidation[s].allowedExtensions)>-1&&(this._options.sizeLimit=this._options.fileValidation[s].sizeLimit)}if(!this._isAllowedExtension(n)){this._error("typeError",n);return!1}if(r===0){this._error("emptyError",n);return!1}if(r&&this._options.sizeLimit&&r>this._options.sizeLimit){this._error("sizeError",n);return!1}if(r&&r<this._options.minSizeLimit){this._error("minSizeError",n);return!1}return!0}});qq.extend(this._options.uploader,n);this.jrUploader=new qq.FileUploader(this._options.uploader);jreviewsMedia.uploadValidation()};jreviewsMedia.uploadValidation=function(){var t=e("#jr-user-info"),n=e("#jr-terms-checkbox-upload, #jr-terms-checkbox-url, #jr-terms-checkbox-link");n.on("change",function(t){var r=e(this);r.is(":checked")?n.attr("checked","checked"):n.removeAttr("checked")});e(".jr-upload-button input, #jr-upload-url-submit, #jr-embed-submit").on("click beginUpload",function(r){var i=t.serializeObject()||{},s=i["data[Media][name]"],o=i["data[Media][email]"],u=e(".jr-media-message"),a=t.find(".jr-user-name").data("required")||!1,f=t.find(".jr-user-email").data("required")||!1;u.html("");jreviewsMedia.upload_valid=!0;if(t.length>0)if(o!==undefined&&f&&o===""||s!==undefined&&a&&s===""){f&&o===""&&u.show().prepend('<li class="jr-user-validation">'+jreviews.__t("VALIDATE_EMAIL")+"</li>");a&&s===""&&u.show().prepend('<li class="jr-user-validation">'+jreviews.__t("VALIDATE_NAME")+"</li>");jreviewsMedia.upload_valid=!1;r.preventDefault()}else jreviewsMedia.upload_valid=!0;if(n.length&&!n.is(":checked")){u.show().prepend('<li class="jr-user-validation">'+jreviews.__t("VALIDATE_TOS")+"</li>");jreviewsMedia.upload_valid=!1;r.preventDefault()}else jreviewsMedia.upload_valid=jreviewsMedia.upload_valid&&!0;u.find("li").length===0&&u.slideUp()})};jreviewsMedia.addMediaDiv=function(t,n){var r=t.embed||!1,i=e(e.trim(e("#jr-media-template").html())).addClass("jr-"+t.media_type).attr("id","mediaForm"+t.media_id),s="mediaForm"+t.media_id,o;t.embed===!0||t.upload_url===!0?o=i.wrap('<div class="jr-upload-success jrMediaDiv" />').parent():o=i;var u=o.find(".jr-media-spinner");t.media_type=="photo"&&o.find(".jr-media-input-description").closest(".jrFieldDiv").remove();o.find(".jr-media-update").on("click",function(e){e.preventDefault();u.show();jreviews.dispatch({controller:"media",action:"_saveEdit",method:"post",form_id:s}).done(function(e){u.hide()})});o.find(".jr-media-delete-upload").on("click",function(t){var n=o.is("form")?o.attr("id"):o.find("form").attr("id");t.preventDefault();u.removeClass("jrHidden");var r=jreviews.dispatch({controller:"media",action:"_delete",method:"post",form_id:n});r.done(function(t){var n=o.hasClass("jr-upload-success")?o:o.closest(".jr-upload-success");n.slideUp(300,function(){e(this).remove();e("div.jr-tabs").find("div[id$='-tab']").trigger("delete")})})});o.find(".jr-media-filename").html(n);t.approved==1?o.find(".jr-media-approved").css("display","inline-block"):o.find(".jr-media-pending").css("display","inline-block");o.find(".jr-media-input-title").val(t.title?t.title:n);o.find(".jr-media-input-description").html(t.description?t.description:"");o.find(".jr-media-media-id").val(t.media_id);o.find(".jr-media-token").attr("name",t.token);this.addElement(t.media_id,o);var a=this.jrUploader._getItemByFileId(t.id);if(t.embed)e(".media-linked-videos").show().prepend(o);else{(t.media_type=="video"||t.media_type=="audio")&&o.find(".jr-encoding-progress, .jr-encoding-info").show();a?e(a).html(o):e(".media-file-list-url").append(o).show()}};jreviewsMedia.updateThumb=function(t){if(t.thumb_url!==undefined&&t.thumb_url!==""){var n=this.getElement(t.media_id),r=e("<img />").attr("src",t.thumb_url).css({width:"75px",height:"auto"});n.find("div.jr-media-thumb").html(r)}};jreviewsMedia.checkEncodingJobStatus=function(t){if(t.encoding_job===null)return;var n=this,r=t.encoding_job.id,i=t.media_id,s=jreviews.dispatch({method:"get",type:"json",controller:"media_upload",action:"checkJobStatus",data:{job_id:r,media_id:i}});s.done(function(r){var s=n.getElement(i);if(r.state=="processing")setTimeout(function(){n.checkEncodingJobStatus(t)},jreviewsMedia._options.polling_period);else if(r.state=="failed")s.find(".jr-media-encoding-failed").css("display","inline-block");else if(r.state=="cancelled")s.find(".jr-media-encoding-cancelled").css("display","inline-block");else{e(".jr-encoding-progress, .jr-encoding-info").remove();n.updateThumb(r)}})};jreviewsMedia.embed=function(){var t=this,n=jreviews.admin?"admin/admin_media_upload":"media_upload",r=jreviews.dispatch({controller:n,action:"_embedVideo",form_id:"jr-form-media-embed",type:"json"});e(".jr-media-message").html("");r.done(function(n){if(n.success){e("input#jr-embed-url").val("");t.addMediaDiv(n,n.service);t.updateThumb(n);e(".jr-embed-complete-actions").slideDown()}else e(".jr-media-message").html(jreviews.__t(n.str)).show();return n});return r};jreviewsMedia.uploadFromUrl=function(){var t=this,n=jreviews.admin?"admin/admin_media_upload":"media_upload",r=jreviews.dispatch({controller:n,action:"_uploadUrl",form_id:"jr-form-media-upload-url",type:"json"});e(".jr-media-message").html("");r.done(function(n){e("input#jr-upload-url").val("");if(n.success===!0){t.addMediaDiv(n,n.filename);n.state=="finished"&&n.thumb_url!==""&&t.updateThumb(n);n.success&&n.encoding_job!==undefined&&t.checkEncodingJobStatus(n);e(".jr-upload-url-complete-actions").slideDown()}else e(".jr-media-message").html(jreviews.__t(n.str)).show();return n});return r};jreviewsMedia.initActions=function(t){var n=e("."+t),r=n.find(".jr-media-actions"),i=r.data("listing-id"),s=r.data("review-id"),o=r.data("media-id"),u=r.data("media-extension"),a,f;r.data("media-id",o).data("listing-id",i).data("review-id",s).data("extension",u);var l=r.find(".jr-media-like-dislike button"),c=r.find(".jr-media-like"),h=r.find(".jr-media-dislike");if(n.hasClass("jr-video-gallery")){sliderItem=n.find("#jr-video-slider").find('[data-media-id="'+o+'"]');sliderItem.length>0&&(undefined===sliderItem.attr("data-voted")?l.removeAttr("disabled"):l.attr("disabled","disabled"))}else if(n.hasClass("jr-photo-gallery"))if(undefined===n.data("voted-"+o))l.removeAttr("disabled");else{var p=n.data("media"+o)||{};p.likes&&c.find(".jr-count").html(p.likes);p.dislikes&&h.find(".jr-count").html(p.dislikes);l.attr("disabled","disabled")}n.off("click",".jr-media-like-dislike button").on("click",".jr-media-like-dislike button",function(){var t=e(this),r=t.data("like-action"),i=t.find(".jr-count"),s,u=jreviews.dispatch({controller:"media",action:r,type:"json",data:{m:o}});u.done(function(e){c.off("click");h.off("click");voteCount=parseInt(i.html(),10)+1;e.success&&i.html(voteCount);if(n.hasClass("jr-video-gallery")&&sliderItem.length>0){sliderItem.attr("data-"+(r=="_like"?"likes":"dislikes"),voteCount);sliderItem.attr("data-voted",1)}else if(n.hasClass("jr-photo-gallery")){if(e.success){var t=n.data("media"+o)||{};if(r=="_like"){t.likes=voteCount;t.dislikes=parseInt(h.find(".jr-count").html(),10)}else{t.likes=parseInt(c.find(".jr-count").html(),10);t.dislikes=voteCount}n.data("media"+o,t)}n.data("voted-"+o,1)}l.attr("disabled","disabled")})})};jreviewsMedia.videoGallery={init:function(){if("undefined"!=typeof videojs){var t=e("div.jr-video-gallery");if(t.length){var n=t.find("#jr-video-player");if(n.length){var r=videojs("jr-video-player").ready(function(){function o(){var t=document.getElementById(e.b.id).parentElement.offsetWidth;e.width(t).height(t*s)}var e=this,r=n.data("width"),i=n.data("height"),s=i/r;o();window.onresize=o;var u=t.closest(".jr-tabs");u.length&&u.bind("tabsshow",function(e,n){n.panel.id==t.closest(".ui-tabs-panel").attr("id")&&o()})});n.on("jrVideoDestroy",function(){r.destroy();e(this).remove()})}t.fitVids();jreviewsMedia.videoGallery.slider(t)}}},slider:function(t){var n=t.find("#jr-video-slider"),r=n.find(".jr-slider-item"),i=r.length,s=n.data("media-id"),o=t.width(),u=function(){o=t.width();n.addClass("jrSliderSideArrows");i<2&&n.hide();maxNumVideos=Math.floor(o/130);if(i>maxNumVideos){var e=n.not(".jr-ready").addClass("jr-ready").find(".jrVideoList").bxSlider({infiniteLoop:!1,pager:!1,controls:!0,minSlides:2,maxSlides:10,moveSlides:1,slideMargin:0,slideWidth:122}),r=n.closest(".jr-tabs");r.length&&r.bind("tabsshow",function(t,r){r.panel.id==n.closest(".ui-tabs-panel").attr("id")&&e.reloadSlider()})}else{typeof e!="undefined"&&e.destroySlider();n.removeClass("jrSliderSideArrows")}};u();e(window).resize(function(){u();typeof sliderWrapper!="undefined"&&sliderWrapper.reloadSlider()});jreviewsMedia.initActions("jr-video-gallery");n.on("click","a.mediaVideo",function(n){n.preventDefault();var r=e(this).closest("div.jr-slider-item").clone(),i=e(this).data("path"),s=e(".jr-video-embed-player"),o=e(".video-js-box"),u=_V_("jr-video-player"),a,f=r.find("a"),l=r.find("a"),c=e(".jr-media-actions"),h=l.data("media-id"),p=t.find("div#jr-video-current-info");c.data({"listing-id":l.data("listing-id"),"review-id":l.data("review-id"),"media-id":h,"media-extension":l.data("media-extension"),likes:l.data("likes"),dislikes:l.data("dislikes")});jreviewsMedia.initActions("jr-video-gallery");if(e(this).data("views")===undefined){jreviews.dispatch({controller:"media",action:"_increaseView",data:{m:h}});e(this).data("views",!0)}r.find(".jr-media-info").removeClass("jrHidden");p.html(r.html()).on("click","a",function(e){e.preventDefault()});t.find(".jr-media-actions .jr-media-like .jr-count").html(l.data("likes"));t.find(".jr-media-actions .jr-media-dislike .jr-count").html(l.data("dislikes"));if(f.data("embed")!==""){s.find("iframe").length===0?a=e("<iframe></iframe>"):a=s.find("iframe");e.each(f.data("embedAttr"),function(e,t){a.attr(e,t)});s.find("iframe").length===0&&a.appendTo(s);o.hide();s.show()}else{s.hide();o.show();u.src([{type:"video/mp4",src:i+".mp4"},{type:"video/webm",src:i+".webm"}]);e(".vjs-poster").attr("src",i+".jpg");u.load()}window.onresize();t.fitVids()});s?n.find('[data-media-id="'+s+'"]').trigger("click"):n.first().trigger("click")}};jreviewsMedia.reorder=function(e,t){var n=t.item.closest(".ui-sortable");listing_id=n.data("listing-id"),extension=n.data("extension"),media_type=n.data("media-type"),tokens=n.data("token-s"),tokeni=n.data("token-i"),ordering=n.sortable("toArray");var r={"data[listing_id]":listing_id,"data[extension]":extension,"data[ordering]":ordering,"data[media_type]":media_type};r[tokens]=1;r[tokeni]=1;var i=jreviews.dispatch({method:"get",controller:"media",action:"reorder",data:r});i.done(function(e){e.success||jreviews.dialog.alert(jreviews.__t("PROCESS_REQUEST_ERROR"))})};jreviewsMedia.photoGallery={init:function(){var t=e("div.jr-photo-gallery");if(t.length===0)return!1;var n=t.closest(".jr-tabs");n.length?n.bind("tabsshow",function(e,n){n.panel.id==t.closest(".ui-tabs-panel").attr("id")&&setTimeout(function(){jreviewsMedia.photoGallery.render(t)},100)}):jreviewsMedia.photoGallery.render(t)},render:function(t){var n=t.closest(".jr-listing-detail"),r=t.find("#jr-photo-slideshow"),i=r.data("media-id"),s=r.data("height"),o=!1,u;i!==undefined&&e.each(data,function(e,t){if(t.m==i){u=e;return!1}});r.parent().hasClass("jrPhotoGalleryCompact")&&(o=!0);r.galleria({debug:!1,dataSource:data,responsive:!0,height:s,initialTransition:"fade",lightbox:o,layerFollow:!1,imagePosition:"center bottom",show:u,extend:function(t){var i=this;if(i.getDataLength()==1){i.$("image-nav").hide();var s=i.$("thumbnails-container"),o=s.height(),u=i.$("container"),a=u.height()-o;i.$("thumbnails-container").hide();e("#jr-photo-slideshow").height(a)}window.history.replaceState&&i.bind("loadstart",function(){var t=i.getIndex();e.each(data,function(r,i){if(t==r){if(!n.length){var s={};s.m=i.m;var o=jreviewsMedia.makeNewQueryString(s),u=window.location.pathname.replace(new RegExp("/m:[a-z0-9]+/","i"),"/");window.history.replaceState(s,"",u+o)}if(e(this).data("views")===undefined){jreviews.dispatch({controller:"media",action:"_increaseView",data:{m:i.m}});e(this).data("views",!0)}}})});r.not("jrPhotoOverlay")&&i.bind("image",function(t){e("#jr-gallery-description").html(t.galleriaData.layer)});i.bind("image",function(){jreviewsMedia.initActions("jr-photo-gallery")})}});r.hasClass("jrPhotoOverlay")&&r.hover(function(){r.find(".jr-photo-info, .jr-photo-caption").hide().slideDown(200)},function(){r.find(".jr-photo-info, .jr-photo-caption").show().slideUp(200)})}};jreviewsMedia.audioPlayer=function(){var t=e("div.jr-audio-player");t.each(function(){var t=e(this),n=t.siblings(".jr-audio-tracks"),r=t.data("tracks"),i=t.data("swpath");new jPlayerPlaylist({jPlayer:"#"+t.attr("id"),cssSelectorAncestor:"#"+n.attr("id")},r,{swfPath:i,supplied:"oga, m4a, mp3",playlistOptions:{freeItemClass:"jrButton jrSmall",downloadText:'<span class="jrIconArrowDown"></span>'+jreviews.__t("DOWNLOAD")}})});var n=jQuery(".jp-playlist");n.each(function(){var e=jQuery(this),t=e.closest(".jr-audio-tracks").siblings(".jr-audio-player"),n=t.data("tracks");jQuery(n).each(function(t,n){var r=e.find("li").eq(t).find("div"),i='<span style="float:right"><a href="" class="jrButton jrSmall"><span class="jrIconArrowDown"></span>Download</a></span>';r.append(i)})})};jreviewsMedia.getUrlParams=function(){var e=window.location.search;e=e.replace("?","");var t=e.split("&"),n={};for(var r=0;r<t.length;r++){var i=t[r].split("=");i[1]!==undefined&&(n[i[0]]=i[1])}return n};jreviewsMedia.makeNewQueryString=function(t){var n=jreviewsMedia.getUrlParams(),r=[],i="";e.each(t,function(e,t){n[e]=t});if(jreviews.jparams){e.each(n,function(e,t){r.push(e+"="+t)});return"?"+r.join("&")}e.each(n,function(e,t){r.push(e+":"+t)});return r.join("/")+"/"}})(jQuery);(function(e){e.fn.fitVids=function(t){var n={customSelector:null},r=document.createElement("div"),i=document.getElementsByTagName("base")[0]||document.getElementsByTagName("script")[0];r.className="fit-vids-style";r.innerHTML="&shy;<style>         	  .fluid-width-video-wrapper {        		 width: 100%;                     		 position: relative;              		 padding: 0;                      	  }                                   										  	  .fluid-width-video-wrapper iframe,  	  .fluid-width-video-wrapper object,  	  .fluid-width-video-wrapper embed {  		 position: absolute;              		 top: 0;                          		 left: 0;                         		 width: 100%;                     		 height: 100%;                    	  }                                   	</style>";i.parentNode.insertBefore(r,i);t&&e.extend(n,t);return this.each(function(){var t=["iframe[src*='player.vimeo.com']","iframe[src*='www.youtube.com']","iframe[src*='www.youtube-nocookie.com']","iframe[src*='www.dailymotion.com']","object","embed"];n.customSelector&&t.push(n.customSelector);var r=e(this).find(t.join(","));r.each(function(){var t=e(this);if(this.tagName.toLowerCase()==="embed"&&t.parent("object").length||t.parent(".fluid-width-video-wrapper").length)return;var n=this.tagName.toLowerCase()==="object"||t.attr("height")&&!isNaN(parseInt(t.attr("height"),10))?parseInt(t.attr("height"),10):t.height(),r=isNaN(parseInt(t.attr("width"),10))?t.width():parseInt(t.attr("width"),10),i=n/r;if(!t.attr("id")){var s="fitvid"+Math.floor(Math.random()*999999);t.attr("id",s)}t.wrap('<div class="fluid-width-video-wrapper"></div>').parent(".fluid-width-video-wrapper").css("padding-top",i*100+"%");t.removeAttr("height").removeAttr("width")})})}})(jQuery);
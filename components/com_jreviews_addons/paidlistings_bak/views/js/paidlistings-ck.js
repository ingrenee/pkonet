/**
 * JReviews - Reviews Extension
 * Copyright (C) 2010-2013 ClickFWD LLC
 * This is not free software, do not distribute it.
 * For licencing information visit http://www.reviewsforjoomla.com
 * or contact sales@reviewsforjoomla.com
**/(function(e,t){var n=e("div.jr-page");jreviews.paid={init:function(){n=n.length>0?n:e("div.jr-page");jreviews.paid.account.init();jreviews.paid.plan.init();n.on("click",".jr-paid-buy",function(t){t.preventDefault();jreviews.paid.order.dialogForm(e(this))});n.on("plgBeforeRenderListingSave",".jr-submit-listing",function(t,n){jreviews.paid.order.inlineForm(e(this),n);return!1});var t=n.find("#jr-form-listing");t.length&&t.on("click",':radio[name="data[PaidOrder][plan_id]"]',function(){jreviews.paid.plan.plan_selected=e(this).val();jreviews.paid.plan.formFilter(t)})},account:{init:function(){var t=e("#jr-paid-myaccount");if(t.length){t.find(".jr-tabs-myaccount").tabs({cache:!0});t.on("click","#jr-form-account-details .jr-save",function(t){t.preventDefault();jreviews.paid.account.save(e(this))});t.on("click",".jr-invoice",function(t){t.preventDefault();jreviews.paid.invoice.print(e(this))})}},save:function(t){var n=e(".jrLoadingSmall").fadeIn("fast"),r=e("#jr-form-account-details"),i=r.find(".jr-validation"),s=jreviews.dispatch({method:"post",type:"json",form:r});s.done(function(e){e.success?i.html(jreviews.__t("PAID_ACCOUNT_SAVED")).fadeIn().delay(5e3).slideUp():i.html(jreviews.__t("PROCESS_REQUEST_ERROR")).fadeIn().delay(5e3).slideUp()});s.always(function(){n.hide()})}},order:{inlineForm:function(t,n){var r={listing_id:n.listing_id||0,plan_id:n.plan_id||0,plan_type:n.plan_type||0,referrer:n.referrer||""},i=e(".jr-form-listing-outer");n.track&&e("body").append(n.track);var s=jreviews.dispatch({method:"get",type:"html",controller:"paidlistings_orders",action:"_getOrderForm",data:r});s.done(function(t){i.html(t).jrScrollTo();i.find('[id^="jr-paid-order-step"]').hide().css("min-height","400px");var n=i.find("form"),r=n.find(".jr-back"),s=r.next("button");s.show();n.data("step",jreviews.paid.plan.plan_selected?2:1);if(jreviews.paid.plan.plan_selected){i.find("#jr-paid-order-step2").show();r.show()}else i.find("#jr-paid-order-step1").show();n.find(".jr-buttons").show();n.on("click",".jr-back",function(t){t.preventDefault();step=Number(n.data("step"))-1;jreviews.paid.order.previous(n,Number(n.data("step"))-1,e(this))});n.on("click",".jr-continue",function(t){t.preventDefault();var r=Number(n.data("step"))+1;jreviews.paid.order.next(n,r,e(this))});n.on("click",".jr-checkout",function(e){e.preventDefault();jreviews.paid.order.placeOrder(i)});jreviews.paid.order.initOrderForm(n)});return!1},dialogForm:function(t){var n=t.data("title"),r={listing_id:t.data("listing-id")||0,order_id:t.data("order-id")||0,plan_id:t.data("plan-id")||0,plan_type:t.data("plan-type")||0,renewal:t.data("renewal")||0,referrer:t.data("referrer")||""},i=jreviews.dispatch({method:"get",type:"html",controller:"paidlistings_orders",action:"_getOrderForm",data:r});i.done(function(t){var r={};r[jreviews.__t("BACK")]=function(t){var n=e(this),r=e(t.target),i=Number(e(this).data("step"))-1;jreviews.paid.order.previous(n,Number(e(this).data("step"))-1,r)};r[jreviews.__t("CONTINUE")]=function(t){var n=e(this),r=e(t.target),i=Number(e(this).data("step"))+1;jreviews.paid.order.next(n,i,r)};r[jreviews.__t("PLACE_ORDER")]=function(t){var n=e(this);jreviews.paid.order.placeOrder(n)};var i=e.jrDialog(t,{buttons:r,title:n,width:"640px",minHeight:"400"});i.data("step",1);i.find("#jr-paid-listing").html(n);var s=e(".ui-dialog-buttonpane"),o=s.find("button:contains("+jreviews.__t("CONTINUE")+")"),u=s.find("button:contains("+jreviews.__t("BACK")+")"),a=s.find("button:contains("+jreviews.__t("PLACE_ORDER")+")");o.css("padding-right",0).prepend('<span class="jrIconNext jrRight" style="margin-left:10px;margin-right:0;"></span>');u.prepend('<span class="jrIconPrev"></span>').hide();a.prepend('<span class="jrIconCart"></span>').hide();jreviews.paid.order.initOrderForm(i)})},initOrderForm:function(t){t.on("change",'input[type=radio][id^="jr-plan"]',function(){var n=e(this).data("plan"),r=e(this).data("price"),i=t.find("#jr-paid-currency-symbol").html();t.find("#jr-paid-plan-title").html(n);t.find("#jr-paid-plan-selected").html(n+" "+i+r);t.data("plan_id",e(this).val());t.data("price",r);jreviews.paid.order.paymentType(t,e(this))});t.on("click",".jr-paid-coupon-validate",function(e){e.preventDefault();jreviews.paid.order.validateCoupon(t)});t.on("click","#jr-paid-tos",function(){jreviews.paid.order.tosToggle(e(this))});t.find("input:radio:checked").trigger("change").click()},next:function(t,n,r){var i=n,s=t.find("#jr-paid-order-step1"),o=t.find("#jr-paid-order-step"+(n-1)),u=e(".ui-dialog-buttonpane, .jr-buttons"),a=Number(t.data("price")),f=r.prev("button"),l=r.next("button");u.find(".jr-validation").fadeOut().remove();if((n==2||n==3)&&o.find(":radio:checked").length===0){var c=o.find(".jr-validation").clone();u.prepend(c);c.fadeIn();return}if(a===0){t.find("#jr-paid-coupon").hide();i=n+1;o.fadeOut(function(){t.find("#jr-paid-order-step"+i).fadeIn()})}else if(a>0){t.find("#jr-paid-coupon").show();o.fadeOut(function(){t.find("#jr-paid-order-step"+i).fadeIn()})}if(i==3){r.hide();l.show()}i>1&&f.show();t.data("step",i)},previous:function(t,n,r){var i=n,s=t.find("#jr-paid-order-step"+(n+1)),o=e(".ui-dialog-buttonpane, .jr-buttons"),u=r.next("button"),a=u.next("button");o.find(".jr-validation").fadeOut().remove();if(Number(t.data("price"))===0){i=1;s.fadeOut(function(){t.find("#jr-paid-order-step"+i).fadeIn()})}else s.fadeOut(function(){t.find("#jr-paid-order-step"+i).fadeIn()});i<2&&r.hide();i<3&&a.hide();u.show();t.data("step",i)},placeOrder:function(t){var n=t.find("form"),r=n.data("tos"),i=t.find("#jr-paid-order-step3"),s=e(".ui-dialog-buttonpane, .jr-buttons"),o=t.find("#jr-paid-tos-accept");s.find(".jr-validation").fadeOut().remove();if(r==2&&o&&!o.is(":checked")){var u=i.find(".jr-validation").clone();s.prepend(u);u.html(jreviews.__t("PAID_VALIDATE_TOS")).fadeIn();return!1}var a=s.find("button");a.attr("disabled","disabled");var f=e('<span class="jrLoadingSmall">');a.first().before(f);var l=jreviews.dispatch({method:"post",type:"json",form:n});l.done(function(n){if(n.success){if(n.tracking)try{t.find("#jr-paid-tracking").remove();var r=e('<div id="jr-paid-tracking" class="jrHidden">').html(n.tracking);t.append(r)}catch(o){console.log("payment tracking error.");console.log(o)}n.url?window.location.href=n.url:n.form&&e(n.form).attr("display","none").appendTo(t).submit()}else{var u=i.find(".jr-validation").clone();f.remove();a.removeAttr("disabled");s.prepend(u);n.str.length?u.html(jreviews.__t(n.str)).fadeIn():u.html(jreviews.__t("PROCESS_REQUEST_ERRROR")).fadeIn()}})},paymentType:function(t,n){var r=n.data("payment-type"),i=Number(n.data("price")),s=Number(n.data("tax-rate"))||0,o=t.find("#jr-single-payment"),u=t.find("#jr-subscription-payment");if(r===0){o.show();u.hide()}else{o.hide();u.show()}t.find("#jr-order-price,#jr-order-subtotal").html(jreviews.paid.order.formatCurrency(i.toFixed(2)));t.find("#jr-order-tax").html(jreviews.paid.order.formatCurrency((i*s).toFixed(2)));t.find("#jr-order-total").html(jreviews.paid.order.formatCurrency((i+i*s).toFixed(2)));t.find("#jr-single-payment input:radio[data-points-balance]").each(function(n,r){var s=parseFloat(e(r).data("pointsBalance"));if(s<i){e(r).attr("disabled","disabled");t.find("#"+r.id+"_balance").show()}else{t.find("#"+r.id+"_balance").hide();t.find(r).removeAttr("disabled")}});t.find("#jr-paid-plan-selected").html()},validateCoupon:function(e){var t=e.find('input[name="data[PaidOrder][coupon_name]"]'),n=e.find("#jr-coupon-code"),r=e.find("#jr-coupon-error");if(n.val()==="")return!1;var i={coupon:n.val(),plan_id:Number(e.data("plan_id")),listing_id:Number(e.find('input[name="data[PaidOrder][listing_id]"]').val()),order_amount:Number(e.data("price"))};r.fadeOut();var s=jreviews.dispatch({method:"get",type:"json",controller:"paidlistings_orders",action:"validateCoupon",data:i});s.done(function(s){if(s.success){t.val(i.coupon);for(var o in s)e.find("#"+o)&&e.find("#"+o).html(s[o]);n.val("");e.find("#jr-coupon-success").fadeIn().delay(2e3).fadeOut()}else r.fadeIn().delay(2e3).fadeOut()})},tosToggle:function(e){e.data("height")===t&&e.data("height",e.height());var n=e.data("height"),r=e.height();e.height(r==n?r*2:n)},formatCurrency:function(e,n){t===n&&(n="");e=e.toString().replace(/\$|\,/g,"");isNaN(e)&&(e="0");sign=e==(e=Math.abs(e));e=Math.floor(e*100+.50000000001);cents=e%100;e=Math.floor(e/100).toString();cents<10&&(cents="0"+cents);for(var r=0;r<Math.floor((e.length-(1+r))/3);r++)e=e.substring(0,e.length-(4*r+3))+","+e.substring(e.length-(4*r+3));return(sign?"":"-")+n+e+"."+cents}},plan:{controlFieldClass:{},planList:{},plan_selected:null,init:function(){var e=n.closest(".jr-paid-plans"),t=n.find(".jr-plan-info");e.length&&jreviews.paid.plan.formSetup(e);t.length&&jreviews.paid.plan.adjustLayout(t)},adjustLayout:function(e){var t=e.eq(0).find("div").length;for(var n=0;n<t;n++){var r=e.find("div:nth-child("+n+")"),i=jreviews.paid.plan.getHeight(r);r.height(i)}},getHeight:function(t){var n=0;t.each(function(){var t=e(this).height();t>n&&(n=t)});return n},formSetup:function(e){var t=e.find("form");jreviews.cms==1&&jreviews.paid.plan.submitSection(t);jreviews.paid.plan.submitCategory(t)},submitCategory:function(n){var r=e('<div class="jrRoundedPanel" style="text-align:center;"><span class="jrLoadingMedium" style="display:inline;padding:20px;"></span>'+jreviews.__t("Loading...")+"</div>");n.on("change",".jr-cat-select",function(i){var s=e(this);formChooser=n.find(".jr-paid-categories"),formPlans=n.find(".jr-plans-layout"),formCategories=n.find(".jr-form-categories"),selected_cat_id=parseInt(n.find(".jr-cat-select").last().val(),10);var o=formCategories.find("select").index(s)+1;if(jreviews.cms==1){var u=parseInt(n.find(".jr-section-select").val(),10);if(selected_cat_id===0){formPlans.fadeOut().delay(100).html();return!1}}var a=formChooser.find("select,input").serializeArray();a.push({name:"data[level]",value:o});a.push({name:"data[catid]",value:s.val()});var f=jreviews.dispatch({method:"get",type:"json",controller:"paidlistings_plans",action:"_loadForm",data:a});r.insertAfter(formChooser);f.done(function(n){if(n.level!==t){var i=formCategories.children("select");i.each(function(t){t>n.level&&e(this).remove()})}n.select!==t&&formCategories.append(n.select);r.remove();switch(n.action){case"show_form":formPlans.html(n.html).show();planInfo=formPlans.find(".jr-plan-info");jreviews.paid.plan.adjustLayout(planInfo);break;case"hide_form":formPlans.hide();break;case"no_access":formPlans.html(jreviews.__t("LISTING_SUBMIT_DISALLOWED")).show()}})})},submitSection:function(t){t.find(".jr-cat-select").attr("disabled","disabled");t.on("change",".jr-section-select",function(n){var r=e(this),i=t.find(".jr-paid-categories"),s=t.find(".jr-plans-layout"),o=t.find(".jr-cat-select"),u=parseInt(r.val(),10);o.val(0).attr("disabled","disabled");if(u===0){s.fadeOut().delay(100).html();return!1}var a=i.find("select,input").serializeArray(),f=jreviews.dispatch({method:"get",type:"html",controller:"paidlistings_plans",action:"_loadCategories",data:a});f.done(function(e){t.find(".jr-form-categories").html(e)})})},formFilter:function(n){var r=jreviews.paid.plan.plan_selected;if(r===null||r===t)return!1;var i=jreviews.paid.plan.controlFieldClass,s=jreviews.paid.plan.planList["plan"+r],o=s.fields,u=s.free||0,a=n.find("#jr-paid-plan-fields"),f=i.getTabs(),l=Number(s.attachments)>0||s.attachments==="",c=Number(s.photos)>0||s.photos==="",h=Number(s.videos)>0||s.videos==="",p=Number(s.audio)>0||s.audio==="";if(l||c||h||p){n.find(".jr-media").parent("div").show();n.find(".jr-media-paid").toggle(u?!1:!0);n.find(".jr-media").toggle(u?!0:!1)}else n.find(".jr-media").parent("div").hide();a.length===0?n.append('<input type="hidden" id="jr-paid-plan-fields" name="data[Paid][fields]" value="'+o+'" />'):a.val(o);var d=n.find("#jr-paid-plan-list");d.find(":radio[value="+r+"]").length===0&&n.append('<input type="hidden" name="data[PaidOrder][plan_id]" value="'+r+'" />');n.find("fieldset").each(function(){var t=e(this);if(t.attr("class")=="jr-form-review")return!1;var n=t.children(".jrFieldDiv"),r=n.length;if(r>0){n.each(function(){var t=e(this).find(':input[class^="jr_"]');if(t.length){var n=t.attr("class").split(" ")[0];if(typeof jreviews.paid.plan.controlFieldClass.getFieldObj=="function"){var i=jreviews.paid.plan.controlFieldClass.getFieldObj(n);if(i!==!1)if(e.inArray(n,o)==-1){i.closest("div.jrFieldDiv").css("display","none");r--}else i.data("isControlled")===!1&&i.closest("div.jrFieldDiv").show("fast")}}});if(r===0){t.css("display","none");f.length&&t.attr("id")&&f.filter("li#tab_"+t.attr("id").replace("group_","")).hide("fast")}else if(t.data("isControlled")!==!0||t.data("isActive")===!0){t.fadeIn();f.length&&t.attr("id")&&f.filter("li#tab_"+t.attr("id").replace("group_","")).fadeIn("slow")}}})}},invoice:{print:function(e){var t=e.data("url");window.open(t,"invoice","location=no,status=no,toolbar=no,scrollbars=yes,titlebar=no,menubar=yes,resizable=yes,width=900,height=600,directories=no")}}};jreviews.addOnload("paidlistings",jreviews.paid.init)})(jQuery);JRPaid={Plans:{load:function(e){jQuery.get(s2AjaxUri+"&cat_id="+e.cat_id,{"data[controller]":"paidlistings_plans","data[action]":"index",tmpl:"component",format:"raw"},function(e){jQuery("#jrPlansPage").html(e)})}}};